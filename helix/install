#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HELIX_CONFIG_DIR="$HOME/.config/helix"

check_installed() {
    command -v hx &>/dev/null
}

check_configured() {
    [[ -L "$HOME/.config/helix/config.toml" ]]
}

install() {
    echo "Installing Helix from source..."

    # Check if Rust is installed
    if ! command -v cargo &>/dev/null; then
        echo "Rust is not installed. Installing Rust..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
    fi

    mkdir -p "$HELIX_CONFIG_DIR"
    cd "$HELIX_CONFIG_DIR"

    # Clone the Helix repository
    if [[ ! -d "helix-source" ]]; then
        git clone https://github.com/helix-editor/helix helix-source
    fi

    cd helix-source
    git pull  # Get latest changes

    # Build the project
    cargo install --path helix-term --locked

    # Setup runtime files
    echo "Setting up runtime files..."
    ln -sf "$HELIX_CONFIG_DIR/helix-source/runtime" "$HELIX_CONFIG_DIR/runtime"

    # Add hx to ~/bin (cargo install puts binaries in ~/.cargo/bin)
    echo "Adding hx to ~/bin..."
    mkdir -p "$HOME/bin"
    ln -sf "$HOME/.cargo/bin/hx" "$HOME/bin/hx"
}

configure() {
    mkdir -p "$HELIX_CONFIG_DIR"
    ln -sf "$SCRIPT_DIR/config.toml" "$HELIX_CONFIG_DIR/config.toml"
}

apply() {
    # Helix reads config on startup, nothing to reload
    :
}

update() {
    echo "Updating Helix..."
    cd "$HELIX_CONFIG_DIR/helix-source"
    git pull
    cargo install --path helix-term --locked
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
