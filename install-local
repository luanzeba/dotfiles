#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

FAILED_STEPS=()

# Helper to run a step and track failures with persistent error logging
run_step() {
    local name="$1"
    shift
    local output
    local exit_code

    output=$("$@" 2>&1)
    exit_code=$?

    if [[ $exit_code -ne 0 ]]; then
        FAILED_STEPS+=("$name")
        log_error_persistent "install" "$name" "$exit_code" "$output"
        echo "‚ö†Ô∏è  $name failed, continuing..."
        echo "$output"
    else
        [[ -n "$output" ]] && echo "$output"
    fi
}

# Ensure zsh is default shell (needed on Arch, not macOS)
ensure_zsh_default() {
    if [[ "$SHELL" != */zsh ]]; then
        sudo chsh -s "$(which zsh)" "$(whoami)"
    fi
}

# Bootstrap Homebrew on macOS (only when needed for brew-dependent tools)
ensure_homebrew() {
    if ! is_macos; then
        return 0
    fi

    if command -v brew &>/dev/null; then
        return 0
    fi

    echo "Installing Homebrew (required for some tools)..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add to PATH for this session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
}

echo 'üöÄ Starting local machine setup.'

# Phase 1: Tools with direct installs (no Homebrew needed)
log_info "Phase 1: Installing core tools (direct downloads)"
run_step "git/install" bash "$SCRIPT_DIR/git/install"
run_step "bin/install" bash "$SCRIPT_DIR/bin/install"
run_step "go/install" bash "$SCRIPT_DIR/go/install"
run_step "rust/install" bash "$SCRIPT_DIR/rust/install"
run_step "node/install" bash "$SCRIPT_DIR/node/install"
run_step "jj/install" bash "$SCRIPT_DIR/jj/install"
run_step "gh/install" bash "$SCRIPT_DIR/gh/install"
run_step "opencode/install" bash "$SCRIPT_DIR/opencode/install"
run_step "skills/install" bash "$SCRIPT_DIR/skills/install"

# Phase 2: Editors (direct downloads)
log_info "Phase 2: Installing editors"
run_step "nvim/install" zsh "$SCRIPT_DIR/nvim/install"
run_step "helix/install" bash "$SCRIPT_DIR/helix/install"

# Phase 3: Tools requiring Homebrew (macOS) or package managers (Linux)
log_info "Phase 3: Installing package-manager tools"
if is_macos; then
    ensure_homebrew
fi
run_step "tmux/install" bash "$SCRIPT_DIR/tmux/install"
run_step "ghostty/install" bash "$SCRIPT_DIR/ghostty/install"
run_step "1password/install" bash "$SCRIPT_DIR/1password/install"

# Phase 4: Shell setup (after everything else)
log_info "Phase 4: Setting up shell"
if is_arch; then
    ensure_zsh_default
fi
run_step "zsh/install.zsh" zsh "$SCRIPT_DIR/zsh/install.zsh"

# Report any failures
if [[ ${#FAILED_STEPS[@]} -gt 0 ]]; then
    echo ""
    echo "‚ö†Ô∏è  The following steps failed:"
    for step in "${FAILED_STEPS[@]}"; do
        echo "  - $step"
    done
    echo ""
    echo "Run 'dot logs' for error details."
    log_warn "Local setup completed with errors"
else
    log_success "Local setup complete!"
fi
