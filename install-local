#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
FAILED_STEPS=()

# Helper to run a step and track failures
run_step() {
    local name="$1"
    shift
    if ! "$@"; then
        FAILED_STEPS+=("$name")
        echo "‚ö†Ô∏è  $name failed, continuing..."
    fi
}

echo 'üöÄ Starting local machine setup.'

# Ensure zsh is default shell (needed on Arch, not macOS)
ensure_zsh_default() {
    if [[ "$SHELL" != */zsh ]]; then
        sudo chsh -s "$(which zsh)" "$(whoami)"
    fi
}

is_arch() {
    command -v pacman &>/dev/null
}

# Main execution
echo "$(date +'%Y-%m-%d %T') - Configuring tools"
run_step "git/install" bash "$SCRIPT_DIR/git/install"
run_step "tmux/install" bash "$SCRIPT_DIR/tmux/install"
run_step "bin/install" bash "$SCRIPT_DIR/bin/install"

echo "$(date +'%Y-%m-%d %T') - Installing languages and tools"
run_step "go/install" bash "$SCRIPT_DIR/go/install"
run_step "node/install" bash "$SCRIPT_DIR/node/install"
run_step "opencode/install" bash "$SCRIPT_DIR/opencode/install"

echo "$(date +'%Y-%m-%d %T') - Setting up shell"
if is_arch; then
    run_step "ensure zsh default" ensure_zsh_default
fi
run_step "zsh/install.zsh" zsh "$SCRIPT_DIR/zsh/install.zsh"

echo "$(date +'%Y-%m-%d %T') - Setting up editors"
run_step "nvim/install" zsh "$SCRIPT_DIR/nvim/install"
run_step "helix/install" zsh "$SCRIPT_DIR/helix/install"

# Report any failures
if [[ ${#FAILED_STEPS[@]} -gt 0 ]]; then
    echo ""
    echo "‚ö†Ô∏è  The following steps failed:"
    for step in "${FAILED_STEPS[@]}"; do
        echo "  - $step"
    done
    echo ""
    echo "Review the log above for details."
    echo "$(date +'%Y-%m-%d %T') - ‚ö†Ô∏è Local setup completed with errors"
else
    echo "$(date +'%Y-%m-%d %T') - ‚úÖ Local setup complete!"
fi
