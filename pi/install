#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PI_CONFIG_DIR="$HOME/.pi/agent"

check_installed() {
    command -v pi &>/dev/null
}

check_configured() {
    [[ -L "$PI_CONFIG_DIR/settings.json" ]]
}

# Install pi coding agent via npm
install() {
    if command -v pi &>/dev/null; then
        echo "pi already installed"
        return 0
    fi

    # Ensure npm is available
    if ! command -v npm &>/dev/null; then
        echo "npm not found. Please install Node.js first (node/install)"
        return 1
    fi

    echo "Installing pi coding agent..."
    npm install -g @mariozechner/pi-coding-agent
}

# Symlink pi configuration
configure() {
    mkdir -p "$PI_CONFIG_DIR"

    # Symlink settings.json
    if [[ -f "$SCRIPT_DIR/settings.json" ]]; then
        rm -f "$PI_CONFIG_DIR/settings.json"
        ln -s "$SCRIPT_DIR/settings.json" "$PI_CONFIG_DIR/settings.json"
        echo "Linked: $PI_CONFIG_DIR/settings.json"
    fi

    # Create skills directory (will be populated by skills/install)
    mkdir -p "$PI_CONFIG_DIR/skills"

    # Symlink extensions
    if [[ -d "$SCRIPT_DIR/extensions" ]]; then
        mkdir -p "$PI_CONFIG_DIR/extensions"
        for ext in "$SCRIPT_DIR/extensions"/*.ts; do
            [[ -f "$ext" ]] || continue
            local name
            name="$(basename "$ext")"
            rm -f "$PI_CONFIG_DIR/extensions/$name"
            ln -s "$ext" "$PI_CONFIG_DIR/extensions/$name"
            echo "Linked extension: $PI_CONFIG_DIR/extensions/$name"
        done
    fi
}

update() {
    if ! command -v npm &>/dev/null; then
        echo "npm not found, cannot update pi"
        return 1
    fi

    echo "Updating pi coding agent..."
    npm update -g @mariozechner/pi-coding-agent
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
