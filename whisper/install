#!/bin/zsh

# Whisper - OpenAI's speech recognition model
# https://github.com/openai/whisper

SCRIPT_DIR="$(cd "$(dirname "${0}")" && pwd)"

is_macos() {
    [[ "$(uname)" == "Darwin" ]]
}

is_arch() {
    [[ -f /etc/arch-release ]]
}

check_installed() {
    command -v whisper &>/dev/null
}

check_configured() {
    # Whisper has no dotfiles config
    return 0
}

install() {
    echo "Installing Whisper..."

    if is_macos; then
        source "$SCRIPT_DIR/install-macos"
    elif is_arch; then
        source "$SCRIPT_DIR/install-arch"
    else
        echo "Whisper installation only supported on macOS and Arch Linux"
        return 1
    fi
}

configure() {
    # No configuration needed
    :
}

update() {
    if command -v pipx &>/dev/null && pipx list | grep -q openai-whisper; then
        echo "Updating Whisper..."
        pipx upgrade openai-whisper
    fi
}

# Main (only run when executed directly, not when sourced)
# In zsh: ZSH_EVAL_CONTEXT contains 'file' when sourced
# In bash: BASH_SOURCE[0] differs from $0 when sourced
if [[ -z "${ZSH_EVAL_CONTEXT:-}" ]]; then
    # Bash
    [[ "${BASH_SOURCE[0]}" == "${0}" ]] && { install; configure; }
elif [[ ! "$ZSH_EVAL_CONTEXT" == *:file* ]]; then
    # Zsh executed directly (toplevel)
    install
    configure
fi
