#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

check_installed() {
    command -v tmux &>/dev/null
}

check_configured() {
    [[ -L "$HOME/.tmux.conf" ]]
}

install() {
    if command -v tmux &>/dev/null; then
        echo "tmux already installed: $(tmux -V)"
        return 0
    fi

    echo "Installing tmux..."

    if [[ "$(uname)" == "Darwin" ]]; then
        # macOS: tmux requires brew (no prebuilt binaries available)
        if command -v brew &>/dev/null; then
            brew install tmux
        else
            echo "Error: Homebrew required for tmux on macOS"
            echo "Homebrew should be installed by install-local before this script runs."
            echo "You can also install manually: brew install tmux"
            return 1
        fi
    elif command -v pacman &>/dev/null; then
        # Arch Linux
        sudo pacman -S --noconfirm tmux
    elif command -v apt-get &>/dev/null; then
        # Debian/Ubuntu
        sudo apt-get update
        sudo apt-get install -y tmux
    else
        echo "Unknown platform, please install tmux manually"
        return 1
    fi

    echo "tmux installed: $(tmux -V)"
}

configure() {
    ln -sf "$SCRIPT_DIR/.tmux.conf" ~/.tmux.conf
}

apply() {
    # Reload tmux config if tmux is running
    if command -v tmux &>/dev/null && tmux list-sessions &>/dev/null; then
        tmux source-file ~/.tmux.conf
        echo "Reloaded tmux config"
    fi
}

update() {
    if [[ "$(uname)" == "Darwin" ]] && command -v brew &>/dev/null; then
        echo "Updating tmux via brew..."
        brew upgrade tmux 2>/dev/null || echo "tmux already up to date"
    elif command -v pacman &>/dev/null; then
        echo "Updating tmux via pacman..."
        sudo pacman -Syu --noconfirm tmux
    elif command -v apt-get &>/dev/null; then
        echo "Updating tmux via apt..."
        sudo apt-get update
        sudo apt-get install -y tmux
    fi
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
