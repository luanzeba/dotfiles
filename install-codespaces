#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
FAILED_STEPS=()

# Helper to run a step and track failures
run_step() {
    local name="$1"
    shift
    if ! "$@"; then
        FAILED_STEPS+=("$name")
        echo "‚ö†Ô∏è  $name failed, continuing..."
    fi
}

echo 'üöÄ Starting Codespaces setup.'

# Ensure zsh is default shell
ensure_zsh_default() {
    if [[ "$SHELL" != */zsh ]]; then
        sudo chsh -s "$(which zsh)" "$(whoami)"
    fi
}

# Setup codespace friendly name for shell prompt
setup_friendly_name() {
    local friendly_name
    friendly_name=$(gh api "/user/codespaces/$CODESPACE_NAME" -q .display_name 2>/dev/null || true)
    if [[ -n "$friendly_name" && "$friendly_name" != *"Not Found"* ]]; then
        echo "$friendly_name" > "$HOME/.friendly_name"
    fi
}

# Install remote-development-manager for copy/paste and open support
install_rdm() {
    echo "Installing rdm..."
    wget -q https://github.com/BlakeWilliams/remote-development-manager/releases/download/v0.0.3/rdm-linux-amd64 -O /tmp/rdm
    sudo mv /tmp/rdm /usr/bin/rdm
    sudo chmod +x /usr/bin/rdm
    gh config set browser "rdm open"
}

# Install ruby-lsp for GitHub monolith
setup_ruby_lsp() {
    if [[ -d "/workspaces/github" ]]; then
        echo "Setting up ruby-lsp for GitHub monolith..."
        export RAILS_ROOT="/workspaces/github"
        export PATH="$RAILS_ROOT/vendor/ruby/$(/workspaces/github/config/ruby-version)/bin:$PATH"
        gem install ruby-lsp

        # Symlink Ruby tools
        if [[ -d "/workspaces/github/bin" ]]; then
            sudo ln -sf /workspaces/github/bin/rubocop /usr/local/bin/rubocop
            sudo ln -sf /workspaces/github/bin/srb /usr/local/bin/srb
            sudo ln -sf /workspaces/github/bin/solargraph /usr/local/bin/solargraph
        fi
    fi
}

# Install system packages
install_apt_packages() {
    echo "Installing apt packages..."
    sudo apt-get update
    sudo apt -o DPkg::Lock::Timeout=600 install -y \
        build-essential python3-venv ruby-dev fzf bat eza jq ripgrep tmux \
        libfuse2 fuse software-properties-common
}

# Main execution
echo "$(date +'%Y-%m-%d %T') - Installing apt packages"
run_step "apt packages" install_apt_packages

echo "$(date +'%Y-%m-%d %T') - Configuring tools"
run_step "git/install" bash "$SCRIPT_DIR/git/install"
run_step "tmux/install" bash "$SCRIPT_DIR/tmux/install"
run_step "bin/install" bash "$SCRIPT_DIR/bin/install"

echo "$(date +'%Y-%m-%d %T') - Installing languages and tools"
run_step "rust/install" bash "$SCRIPT_DIR/rust/install"
run_step "go/install" bash "$SCRIPT_DIR/go/install"
run_step "node/install" bash "$SCRIPT_DIR/node/install"
run_step "opencode/install" bash "$SCRIPT_DIR/opencode/install"

echo "$(date +'%Y-%m-%d %T') - Setting up shell"
run_step "ensure zsh default" ensure_zsh_default
run_step "zsh/install.zsh" zsh "$SCRIPT_DIR/zsh/install.zsh"

echo "$(date +'%Y-%m-%d %T') - Setting up Neovim"
run_step "nvim/install" zsh "$SCRIPT_DIR/nvim/install"

echo "$(date +'%Y-%m-%d %T') - Codespaces-specific setup"
run_step "setup friendly name" setup_friendly_name
run_step "install rdm" install_rdm
run_step "setup ruby-lsp" setup_ruby_lsp

# Report any failures
if [[ ${#FAILED_STEPS[@]} -gt 0 ]]; then
    echo ""
    echo "‚ö†Ô∏è  The following steps failed:"
    for step in "${FAILED_STEPS[@]}"; do
        echo "  - $step"
    done
    echo ""
    echo "Review the log above for details."
    echo "$(date +'%Y-%m-%d %T') - ‚ö†Ô∏è Codespaces setup completed with errors"
else
    echo "$(date +'%Y-%m-%d %T') - ‚úÖ Codespaces setup complete!"
fi
