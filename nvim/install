#!/bin/zsh

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

check_installed() {
    command -v nvim &>/dev/null && [[ -L "$HOME/.config/nvim" ]]
}

install() {
    if command -v nvim &>/dev/null; then
        echo "Neovim already installed, skipping binary install..."
        return 0
    fi
    
    echo "Neovim not found, installing..."
    mkdir -p ~/bin
    cd ~/bin
    
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
    chmod u+x nvim.appimage
    
    if ./nvim.appimage --version &>/dev/null; then
        ln -sf ./nvim.appimage nvim
    else
        # FUSE not available, extract appimage
        ./nvim.appimage --appimage-extract
        sudo mv squashfs-root /
        ln -sf /squashfs-root/AppRun ~/bin/nvim
        rm nvim.appimage
    fi
}

configure() {
    # Symlink nvim config
    mkdir -p "$HOME/.config"
    if [[ ! -e "$HOME/.config/nvim" ]]; then
        ln -s "$SCRIPT_DIR" "$HOME/.config/nvim"
    elif [[ -L "$HOME/.config/nvim" ]]; then
        ln -sfn "$SCRIPT_DIR" "$HOME/.config/nvim"
    fi
    
    local nvim_path
    nvim_path=$(command -v nvim)
    
    # Install plugins
    $nvim_path --headless "+Lazy! sync" +qa
    $nvim_path --headless +"MasonInstallAll" +qa 2>/dev/null || true
    
    # Accept Copilot license
    mkdir -p ~/.config/github-copilot
    echo '{"luanzeba":{"version":"2021-10-14"}}' > ~/.config/github-copilot/terms.json
    
    # Install treesitter parsers
    $nvim_path --headless +"TSInstall! go ruby" +qa 2>/dev/null || true
}

apply() {
    # Nvim reads config on startup, nothing to reload
    # But we can sync plugins
    if command -v nvim &>/dev/null; then
        nvim --headless "+Lazy! sync" +qa 2>/dev/null || true
    fi
}

update() {
    echo "Updating Neovim plugins..."
    if command -v nvim &>/dev/null; then
        nvim --headless "+Lazy! update" +qa
        nvim --headless "+MasonUpdate" +qa 2>/dev/null || true
        nvim --headless "+TSUpdate" +qa 2>/dev/null || true
    fi
}

# Main (only run when executed directly, not when sourced)
if [[ "${ZSH_EVAL_CONTEXT:-}" == "toplevel" ]] || [[ "${BASH_SOURCE[0]:-$0}" == "${0}" ]]; then
    install
    configure
fi
