#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOCAL_BIN="$HOME/.local/bin"

install() {
    # Scripts are part of dotfiles, nothing to install
    :
}

check_installed() {
    # Scripts are part of dotfiles repo, always "installed"
    return 0
}

check_configured() {
    # Check if dotfiles script is accessible in ~/.local/bin
    [[ -x "$LOCAL_BIN/dotfiles" ]]
}

configure() {
    # Create dot -> dotfiles alias in the repo itself
    if [[ ! -e "$SCRIPT_DIR/dot" ]]; then
        ln -s dotfiles "$SCRIPT_DIR/dot"
    fi

    # Ensure ~/.local/bin exists
    mkdir -p "$LOCAL_BIN"

    # Symlink each script individually to ~/.local/bin
    for script in "$SCRIPT_DIR"/*; do
        local name
        name=$(basename "$script")
        # Skip the install script itself
        [[ "$name" == "install" ]] && continue
        ln -sf "$script" "$LOCAL_BIN/$name"
    done
}

apply() {
    # TODO: Remove this migration block after 2025-03-01 (all machines should be migrated by then)
    # Migration: Remove old ~/bin symlink if it points to dotfiles/bin
    if [[ -L "$HOME/bin" ]]; then
        local target
        target=$(readlink "$HOME/bin")
        if [[ "$target" == *"dotfiles/bin"* ]]; then
            echo "Migrating from ~/bin to ~/.local/bin..."
            rm "$HOME/bin"
        fi
    fi

    # Ensure all scripts are symlinked to ~/.local/bin
    configure
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
