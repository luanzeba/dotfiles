#!/bin/bash
#
# rotate-github-token - Semi-automated GitHub PAT rotation helper
#
# This script helps rotate GitHub Personal Access Tokens by:
# 1. Opening the GitHub PAT creation page
# 2. Prompting for the new token
# 3. Storing it in 1Password
# 4. Testing it works
#

set -e

VAULT="Private"
ITEM_NAME="GitHub PAT"
FIELD_NAME="credential"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo_info() { echo -e "${GREEN}==>${NC} $1"; }
echo_warn() { echo -e "${YELLOW}==>${NC} $1"; }
echo_error() { echo -e "${RED}==>${NC} $1"; }

# Check if op CLI is installed
if ! command -v op &>/dev/null; then
    echo_error "1Password CLI (op) is not installed."
    echo "Run: dotfiles/1password/install"
    exit 1
fi

# Check if signed in to 1Password
if ! op account list &>/dev/null 2>&1; then
    echo_error "Not signed in to 1Password CLI."
    echo "Run: eval \$(op signin)"
    exit 1
fi

# Open GitHub PAT creation page
echo_info "Opening GitHub token creation page..."
echo ""
echo "Create a new Fine-grained Personal Access Token with these settings:"
echo "  - Token name: opencode-mcp (or similar)"
echo "  - Expiration: 90 days (recommended)"
echo "  - Repository access: All repositories (or select specific repos)"
echo "  - Repository permissions:"
echo "    - Contents: Read and write"
echo "    - Issues: Read and write"
echo "    - Pull requests: Read and write"
echo "    - Metadata: Read-only (automatically selected)"
echo "  - Account permissions:"
echo "    - Codespaces: Read and write (required for 'gh cs' commands)"
echo ""

# Open the URL
if [[ "$(uname)" == "Darwin" ]]; then
    open "https://github.com/settings/personal-access-tokens/new"
elif command -v xdg-open &>/dev/null; then
    xdg-open "https://github.com/settings/personal-access-tokens/new"
else
    echo "Open this URL in your browser:"
    echo "  https://github.com/settings/personal-access-tokens/new"
fi

echo ""
echo_info "After creating the token, paste it below."
echo -n "New GitHub token: "
read -rs NEW_TOKEN
echo ""

if [[ -z "$NEW_TOKEN" ]]; then
    echo_error "No token provided. Aborting."
    exit 1
fi

# Check if the item exists
if op item get "$ITEM_NAME" --vault "$VAULT" &>/dev/null 2>&1; then
    echo_info "Updating existing 1Password item '$ITEM_NAME'..."
    op item edit "$ITEM_NAME" --vault "$VAULT" "$FIELD_NAME=$NEW_TOKEN" >/dev/null
else
    echo_info "Creating new 1Password item '$ITEM_NAME'..."
    op item create \
        --category "API Credential" \
        --title "$ITEM_NAME" \
        --vault "$VAULT" \
        "$FIELD_NAME=$NEW_TOKEN" >/dev/null
fi

# Test the token
echo_info "Testing the token..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -H "Authorization: Bearer $NEW_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    "https://api.github.com/user")

if [[ "$HTTP_CODE" == "200" ]]; then
    echo_info "Token is valid!"
else
    echo_error "Token test failed (HTTP $HTTP_CODE). The token may be invalid."
    echo "You can still try using it, or run this script again."
fi

echo ""
echo_info "Done! Token stored in 1Password."
echo ""
echo "To use the new token, reload your shell:"
echo "  exec zsh"
echo ""
echo "Then verify it's loaded:"
echo "  echo \$GITHUB_TOKEN"
