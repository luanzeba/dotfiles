#!/bin/bash
set -e

FNM_DIR="$HOME/.local/share/fnm"

check_installed() {
    command -v node &>/dev/null
}

install() {
    if command -v fnm &>/dev/null; then
        echo "fnm already installed"
    else
        echo "Installing fnm..."
        curl -fsSL https://fnm.vercel.app/install | bash -s -- --install-dir "$FNM_DIR" --skip-shell
    fi

    # Ensure fnm is in PATH for this script
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)"

    echo "Installing latest LTS Node.js..."
    fnm install --lts
    fnm default lts-latest
}

configure() {
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)"

    if ! command -v npm &>/dev/null; then
        echo "npm not available, skipping TypeScript packages"
        return
    fi

    echo "Installing TypeScript packages..."
    npm install -g typescript-language-server typescript prettier
}

update() {
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)"
    
    echo "Updating Node.js to latest LTS..."
    fnm install --lts
    fnm default lts-latest
    
    echo "Updating global npm packages..."
    npm update -g
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
