#!/bin/bash
set -e

FNM_DIR="$HOME/.local/share/fnm"

check_installed() {
    command -v node &>/dev/null
}

check_configured() {
    # Check if TypeScript packages are installed
    command -v typescript-language-server &>/dev/null
}

install() {
    if command -v fnm &>/dev/null; then
        echo "fnm already installed"
    else
        echo "Installing fnm..."

        local os
        case "$(uname -s)" in
            Darwin) os="macos" ;;
            Linux) os="linux" ;;
            *) echo "Unsupported OS: $(uname -s)"; return 1 ;;
        esac

        # Download fnm binary from GitHub releases
        local url="https://github.com/Schniz/fnm/releases/latest/download/fnm-${os}.zip"

        echo "Downloading fnm from $url..."
        mkdir -p "$FNM_DIR"
        curl -fsSL "$url" -o /tmp/fnm.zip

        if [[ ! -s /tmp/fnm.zip ]]; then
            echo "Error: Failed to download fnm"
            return 1
        fi

        unzip -o /tmp/fnm.zip -d "$FNM_DIR"
        chmod +x "$FNM_DIR/fnm"
        rm /tmp/fnm.zip

        echo "fnm installed to $FNM_DIR"
    fi

    # Ensure fnm is in PATH for this script
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)"

    echo "Installing latest LTS Node.js..."
    fnm install --lts
    fnm default lts-latest
}

configure() {
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)" 2>/dev/null || true

    if ! command -v npm &>/dev/null; then
        echo "npm not available, skipping TypeScript packages"
        return
    fi

    echo "Installing TypeScript packages..."
    npm install -g typescript-language-server typescript prettier
}

update() {
    export PATH="$FNM_DIR:$PATH"
    eval "$(fnm env)" 2>/dev/null || true

    # Update fnm itself
    echo "Updating fnm..."
    local os
    case "$(uname -s)" in
        Darwin) os="macos" ;;
        Linux) os="linux" ;;
        *) echo "Unsupported OS"; return 1 ;;
    esac

    local url="https://github.com/Schniz/fnm/releases/latest/download/fnm-${os}.zip"
    curl -fsSL "$url" -o /tmp/fnm.zip
    unzip -o /tmp/fnm.zip -d "$FNM_DIR"
    chmod +x "$FNM_DIR/fnm"
    rm /tmp/fnm.zip

    echo "Updating Node.js to latest LTS..."
    fnm install --lts
    fnm default lts-latest

    if command -v npm &>/dev/null; then
        echo "Updating global npm packages..."
        npm update -g
    fi
}

# Main (only run when executed directly, not when sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install
    configure
fi
