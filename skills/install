#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
EXTERNAL_DIR="$SCRIPT_DIR/external"
SKILL_CREATOR_DIR="$EXTERNAL_DIR/skill-creator"
PRIVATE_DIR="$EXTERNAL_DIR/private"
PRIVATE_REPO="luanzeba/private-dotfiles"

# Download skill-creator from Anthropic's skills repo
download_skill_creator() {
    local base_url="https://raw.githubusercontent.com/anthropics/skills/main/skills/skill-creator"
    local files=(
        "SKILL.md"
        "LICENSE.txt"
        "references/output-patterns.md"
        "references/workflows.md"
        "scripts/init_skill.py"
        "scripts/package_skill.py"
        "scripts/quick_validate.py"
    )

    echo "Downloading skill-creator from anthropics/skills..."
    mkdir -p "$SKILL_CREATOR_DIR/references" "$SKILL_CREATOR_DIR/scripts"

    local failed=0
    for file in "${files[@]}"; do
        if ! curl -sSL --fail "$base_url/$file" -o "$SKILL_CREATOR_DIR/$file" 2>/dev/null; then
            failed=1
            break
        fi
    done

    if [[ $failed -eq 1 ]]; then
        echo "WARNING: Failed to download skill-creator from GitHub."
        echo "  This may be due to:"
        echo "    - Network connectivity issues"
        echo "    - Changes in the anthropics/skills repository structure"
        echo "  You can manually install from: https://github.com/anthropics/skills"
        rm -rf "$SKILL_CREATOR_DIR"
        return 1
    fi

    chmod +x "$SKILL_CREATOR_DIR/scripts/"*.py 2>/dev/null || true
    echo "skill-creator downloaded successfully."
    return 0
}

# Clone or update private-dotfiles repo
download_private_skills() {
    echo "Fetching private skills from $PRIVATE_REPO..."

    if [[ -d "$PRIVATE_DIR/.git" ]]; then
        # Update existing clone
        if ! git -C "$PRIVATE_DIR" pull --ff-only 2>/dev/null; then
            echo "WARNING: Failed to update private skills (may have local changes)"
            return 1
        fi
    else
        # Fresh clone - prefer gh if available (handles auth automatically)
        if command -v gh &>/dev/null && gh auth status &>/dev/null; then
            if ! gh repo clone "$PRIVATE_REPO" "$PRIVATE_DIR" -- --depth 1 2>/dev/null; then
                echo "WARNING: Failed to clone private skills."
                echo "  Ensure you have access to $PRIVATE_REPO"
                return 1
            fi
        else
            # Fall back to SSH
            if ! git clone --depth 1 "git@github.com:$PRIVATE_REPO.git" "$PRIVATE_DIR" 2>/dev/null; then
                echo "WARNING: Failed to clone private skills."
                echo "  Ensure you have access to $PRIVATE_REPO"
                echo "  For SSH: Ensure your SSH key is set up"
                echo "  Or install gh CLI and run 'gh auth login'"
                return 1
            fi
        fi
    fi

    echo "Private skills fetched successfully."
    return 0
}

# Download external and private skills
install() {
    download_skill_creator || echo "Continuing without skill-creator..."
    download_private_skills || echo "Continuing without private skills..."
}

# Symlink a skill to global locations
# Usage: symlink_skill <skill_path> <skill_name>
symlink_skill() {
    local skill_path="$1"
    local skill_name="$2"

    # Only link if the skill exists
    if [[ ! -d "$skill_path" ]]; then
        echo "Skill not found: $skill_path (skipping)"
        return 1
    fi

    # Remove existing symlinks/directories
    rm -rf ~/.config/opencode/skill/"$skill_name"
    rm -rf ~/.claude/skills/"$skill_name"

    # Create new symlinks
    ln -s "$skill_path" ~/.config/opencode/skill/"$skill_name"
    ln -s "$skill_path" ~/.claude/skills/"$skill_name"

    echo "Linked: $skill_name"
    return 0
}

# Create global skill directories and symlink all skills
configure() {
    # Create global skill directories
    mkdir -p ~/.config/opencode/skill
    mkdir -p ~/.claude/skills

    # Link custom skills from this repo
    symlink_skill "$SCRIPT_DIR/dotfiles" "dotfiles"

    # Link external skills
    if [[ -d "$SKILL_CREATOR_DIR" ]]; then
        symlink_skill "$SKILL_CREATOR_DIR" "skill-creator"
    fi

    # Link private skills (each skill in private repo's skills/ directory)
    if [[ -d "$PRIVATE_DIR/skills" ]]; then
        for skill_dir in "$PRIVATE_DIR/skills"/*/; do
            if [[ -d "$skill_dir" ]]; then
                local skill_name
                skill_name=$(basename "$skill_dir")
                symlink_skill "$skill_dir" "$skill_name"
            fi
        done
    fi
}

# Main
echo "Installing skills..."
install
configure
echo ""
echo "Skills installation complete!"
echo ""
echo "Installed skills:"
ls -la ~/.config/opencode/skill/
